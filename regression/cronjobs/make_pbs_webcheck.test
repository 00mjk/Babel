# make_web_installcheck.sh -*- sh -*-
#
# OVERVIEW:
#     This script tests the SVN repository and packaging
#     of the Babel code.  It is intended to be run only
#     on the "official" development platforms.  This script
#     will only do ./configure, make all install installcheck.
#
# REQUIREMENTS:
#     This script assumes several environment variables are
#     set appropriately.  It is normal usage for the envoker of
#     this script to source some other platform specific 
#     configuration file and then envoke this script.
#
#     URL (directory where babel distribution can be found)
#     SH
#     PACKAGE
#     SNAPSHOT_NUMBER
#     PATH
#     LD_LIBRARY_PATH (or equivalent)
#     CLASSPATH
#     SVN
#     SVNROOT
#     MAKE
#     MAKE_FLAGS
#     MAIL
#     PERL
#     ACLOCAL
#     AUTOMAKE
#     AUTOCONF
#     CONFIG_FLAGS
#     CD
#     MKDIR
#     CC
#     CFLAGS
#     CXX
#     CXXFLAGS
#     F77
#     FFLAGS
#     CHGRP
#     TESTGID
#     CHMOD
#     MV
#     SED
#     QSUB
#     QSTAT
#     COMPUTE_ACCOUNT
#     COMPUTE_EMAIL

umask 007
date
echo "Host: " `hostname`
gcc --version
echo "************ rm -rf $PACKAGE ************"
$CHGRP -f ${TESTGID} .
$CHMOD -f ug+rwx .
if test -d $PACKAGE; then
  $CHGRP -Rf ${TESTGID} $PACKAGE
  $CHMOD -Rf ug+rwX $PACKAGE
  olddir=$PACKAGE.old
  if test -d $olddir; then
    $CHGRP -Rf ${TESTGID} $olddir ; $CHMOD -Rf ug+rwX $olddir; rm -rf $olddir
      if test -d $olddir; then
	for in in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 ; do
	  if test -d $olddir.$i; then
	    $CHGRP -Rf ${TESTGID} $olddir.$i ; $CHMOD -Rf ug+rwX $olddir.$i; rm -rf $olddir.$i
	  else
	    olddir=$olddir.$i
	    break
	  fi
	done
      fi
    fi
  $MV -f $PACKAGE $olddir
  rm -rf $olddir
  unset olddir
fi

mkdir $PACKAGE
cd $PACKAGE
PACKAGEDIR=$PACKAGE
echo "************ Wait for ${URL}/${PACKAGE}-nightly.tar.gz ************"
if wget --no-cache --tries 16 --wait 10m ${URL}/${PACKAGE}-nightly.tar.gz && wget --no-cache --tries 16 --wait 10m ${URL}/${PACKAGE}-nightly.tar.gz.sig && gpg --verify ${PACKAGE}-nightly.tar.gz.sig ${PACKAGE}-nightly.tar.gz ; then
  tar --file ${PACKAGE}-nightly.tar.gz --ungzip --extract
  echo "************ Retrieval succeeded and GPG signature passed ************"
  CONFIGURE=`pwd`/${PACKAGEDIR}-${SNAPSHOT_NUMBER}/configure
  if test -e $CONFIGURE ; then
    found="true"
	BABELSRCDIR=`pwd`/${PACKAGEDIR}-${SNAPSHOT_NUMBER}
  else
    echo "************ Nightly tarball is not from today - trying yesterday ************"
    export SNAPSHOT_NUMBER=`date -d yesterday '+%Y%m%d' 2>/dev/null`
    if test -z "$SNAPSHOT_NUMBER"; then
      export SNAPSHOT_NUMBER=`python -c "from time import localtime,strftime,time;print strftime('%Y%m%d', localtime(time()-24*60*60))" 2>/dev/null`
    fi
    if test -n "$SNAPSHOT_NUMBER"; then
      CONFIGURE=`pwd`/${PACKAGEDIR}-${SNAPSHOT_NUMBER}/configure
      if test -e $CONFIGURE ; then
	found="true"
	BABELSRCDIR=`pwd`/${PACKAGEDIR}-${SNAPSHOT_NUMBER}
	echo "************ Using yesterday's nightly tarball ************"
      fi
    fi
  fi
else
  echo "************ Retrieval failed or GPG signature failed ************"
  found="false"
fi
t=`date`
if test "$found" == "true"; then 
  echo "****** $CONFIGURE found at $t ******"
else
  echo "****** $CONFIGURE not found at $t ******"
  exit 1
fi

echo "************ configure  ************"
mkdir build
$CD build
${CONFIGURE} -C --prefix=${PWD}/_inst ${CONFIG_FLAGS} \
    CC=$CC CFLAGS="$CFLAGS -DSIDL_DEBUG_REFCOUNT=1 -O0" CXX=$CXX CXXFLAGS="$CXXFLAGS -DSIDL_DEBUG_REFCOUNT=1 -O0" F77=$F77 FFLAGS="$FFLAGS -O0" FC=$FC FCFLAGS="$FCFLAGS -O0" CPP="$CPP" CPPFLAGS="$CPPFLAGS" LDFLAGS="$LDFLAGS"
if test $? -ne 0; then 
	  echo '****** configure failed ******'
	  exit 1
fi


# Those flags are stored in the Makefiles generated by configure
# anyway; if we do not unset them here, the Python module build step
# will use the wrong set of flags if the CC that Python was built with
# is not the Babel CC
unset CFLAGS CXXFLAGS FFLAGS FCFLAGS CPPFLAGS LDFLAGS


echo "************ $MAKE $MAKE_FLAGS all ************"
$MAKE $MAKE_FLAGS all
if test $? -ne 0; then 
    echo "****** $MAKE $MAKE_FLAGS all failed ******"
    exit 1
fi 

echo "************ $MAKE $MAKE_FLAGS install ************"
$MAKE $MAKE_FLAGS SESSION=${SESSION} install
if test $? -ne 0; then 
    echo "****** $MAKE $MAKE_FLAGS install failed ******"
    exit 1
fi

echo "************ $MAKE $MAKE_FLAGS RUNPYTEST=echo PYFLAGS=-x${XML_ARCHIVE} installcheck ************"
$MAKE $MAKE_FLAGS SESSION=${SESSION} \
RUNPYTEST=echo PYFLAGS=-x${XML_ARCHIVE} installcheck
if test $? -ne 0; then 
    echo "****** $MAKE $MAKE_FLAGS installcheck failed ******"
    exit 1
fi

echo "************ Preparing installcheck.pbs ************"
TESTHOME=`pwd`
$SED "s@XXX_TESTHOME_XXX@${TESTHOME}@" \
		$BABELSRCDIR/contrib/installcheck.pbs \
	| $SED "s/XXX_ACCOUNT_XXX/${COMPUTE_ACCOUNT}/" \
	| $SED "s/XXX_EMAIL_XXX/${COMPUTE_EMAIL}/" \
	> ./installcheck.pbs

echo "************ $QSUB installcheck.pbs ************"
jobhandle=`$QSUB installcheck.pbs`
if test $? -ne 0; then 
    echo "****** $QSUB installcheck.pbs failed ******"
    exit 1
fi
echo "InstallCheck Job Submitted - Job Handle: $jobhandle"
jobid=`echo $jobhandle | cut -d "." -f 1`
echo "InstallCheck Job ID $jobid Queued."
jobstatus="Q"
while test "#$jobstatus#" != '#C#' -a "#$jobstatus#" != '#E#' ; do
	sleep 60
	jobstatus=`$QSTAT -r $jobid | grep $jobid | awk '{print $9}'`
	echo -n "Job ID $jobid Status=$jobstatus @ " ; date
done
if test "#$jobstatus#" != '#C#' ; then
	echo "****** $QSUB installcheck.pbs failed ******"
	exit 1
fi

echo "******** Running Gantlet Post-Processing ********"
cd regression ; make run-gantlet-post

exit 0
